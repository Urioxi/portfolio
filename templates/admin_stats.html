{% extends "base.html" %}

{% block title %}Statistiques Admin - Portfolio Photos{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">üìä Statistiques</h1>
        <p class="text-gray-600">Vue d'ensemble de votre portfolio</p>
    </div>

    <!-- Upload Section -->
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Ajouter une photo</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">S√©lectionner une image</label>
                <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Cat√©gorie</label>
                <select id="categoryInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="Non cat√©goris√©">Non cat√©goris√©</option>
                    <option value="Nature">Nature</option>
                    <option value="Portrait">Portrait</option>
                    <option value="Architecture">Architecture</option>
                    <option value="Voyage">Voyage</option>
                    <option value="Street">Street</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>
            <button id="uploadBtn" onclick="uploadImage()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition shadow-md hover:shadow-lg">
                Uploader la photo
            </button>
            <p id="status" class="text-sm text-gray-600 mt-2"></p>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm mb-1">Total de photos</p>
                    <p class="text-3xl font-bold text-gray-800">{{ stats.total_photos }}</p>
                </div>
                <div class="text-4xl">üì∑</div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm mb-1">Cat√©gories</p>
                    <p class="text-3xl font-bold text-gray-800">{{ stats.categories }}</p>
                </div>
                <div class="text-4xl">üè∑</div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm mb-1">Visites uniques</p>
                    <p class="text-3xl font-bold text-gray-800">{{ stats.unique_visits }}</p>
                </div>
                <div class="text-4xl">üë•</div>
            </div>
        </div>
    </div>

    <!-- Photos par cat√©gorie -->
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Photos par cat√©gorie</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for category, count in stats.photos_by_category.items() %}
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-800">{{ category }}</span>
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">{{ count }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Cr√©er une cat√©gorie -->
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Cr√©er une cat√©gorie</h2>
        <div class="flex gap-4">
            <input type="text" id="newCategoryInput" placeholder="Nom de la cat√©gorie" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <button onclick="createCategory()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition">
                ‚ûï Cr√©er
            </button>
        </div>
        <p id="categoryStatus" class="text-sm text-gray-600 mt-2"></p>
    </div>

    <!-- Liste des photos avec gestion -->
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <h2 class="text-2xl font-semibold text-gray-800">Gestion des photos</h2>
            <div class="w-full md:w-64">
                <label class="block text-sm font-medium text-gray-700 mb-2">Rechercher par titre</label>
                <input type="text" id="searchPhotosInput" placeholder="Tapez le titre..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
        <div id="photosList" class="space-y-4">
            {% for photo in gallery %}
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition photo-item" data-photo-id="{{ photo.id }}" data-photo-title="{{ (photo.title or '')|lower }}">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="md:w-48 flex-shrink-0">
                        <img src="{{ photo.url }}" alt="Photo" class="w-full h-32 object-cover rounded-lg">
                    </div>
                    <div class="flex-1">
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Titre</label>
                            <input type="text" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" 
                                   value="{{ photo.title or '' }}"
                                   data-photo-id="{{ photo.id }}"
                                   id="title-{{ photo.id }}"
                                   placeholder="Titre de la photo">
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cat√©gories (s√©par√©es par virgule)</label>
                            <input type="text" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" 
                                   value="{% if photo.categories %}{{ photo.categories|join(', ') }}{% elif photo.category %}{{ photo.category }}{% else %}Non cat√©goris√©{% endif %}"
                                   data-photo-id="{{ photo.id }}"
                                   id="categories-{{ photo.id }}">
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" 
                                rows="3"
                                data-photo-id="{{ photo.id }}"
                                id="description-{{ photo.id }}">{{ photo.description or '' }}</textarea>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="updatePhoto('{{ photo.id }}')" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-4 rounded-lg transition">
                                üíæ Sauvegarder
                            </button>
                            <button onclick="deletePhoto('{{ photo.id }}')" class="bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-2 px-4 rounded-lg transition">
                                Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function createCategory() {
    const input = document.getElementById('newCategoryInput');
    const status = document.getElementById('categoryStatus');
    const name = input.value.trim();
    
    if (!name) {
        status.textContent = 'Entrez un nom de cat√©gorie';
        status.className = 'text-sm text-red-600 mt-2';
        return;
    }
    
    try {
        const response = await fetch('/create-category', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: name})
        });
        
        const result = await response.json();
        if (result.success) {
            status.textContent = '‚úÖ Cat√©gorie cr√©√©e ! Vous pouvez maintenant l\'utiliser.';
            status.className = 'text-sm text-green-600 mt-2';
            input.value = '';
            setTimeout(() => window.location.reload(), 1000);
        } else {
            status.textContent = '‚ùå Erreur: ' + result.error;
            status.className = 'text-sm text-red-600 mt-2';
        }
    } catch (error) {
        status.textContent = '‚ùå Erreur: ' + error.message;
        status.className = 'text-sm text-red-600 mt-2';
    }
}

async function updatePhoto(photoId) {
    const titleInput = document.getElementById(`title-${photoId}`);
    const categoriesInput = document.getElementById(`categories-${photoId}`);
    const descriptionInput = document.getElementById(`description-${photoId}`);
    
    const categories = categoriesInput.value.split(',').map(c => c.trim()).filter(c => c);
    
    try {
        const response = await fetch(`/update-photo/${photoId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                title: titleInput.value,
                categories: categories,
                description: descriptionInput.value
            })
        });
        
        const result = await response.json();
        if (result.success) {
            alert('‚úÖ Photo mise √† jour avec succ√®s !');
            window.location.reload();
        } else {
            alert('‚ùå Erreur: ' + result.error);
        }
    } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
    }
}

async function deletePhoto(photoId) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette photo ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/delete-photo/${photoId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            alert('‚úÖ Photo supprim√©e !');
            window.location.reload();
        } else {
            alert('‚ùå Erreur: ' + result.error);
        }
    } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
    }
}

// Fonction de recherche dans la liste des photos
function searchPhotos() {
    const searchInput = document.getElementById('searchPhotosInput');
    const searchTerm = searchInput.value.toLowerCase().trim();
    const photoItems = document.querySelectorAll('.photo-item');
    
    photoItems.forEach(item => {
        const title = item.getAttribute('data-photo-title') || '';
        if (title.includes(searchTerm)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
    
    // Afficher un message si aucun r√©sultat
    const visibleItems = Array.from(photoItems).filter(item => item.style.display !== 'none');
    const photosList = document.getElementById('photosList');
    let noResultsMsg = document.getElementById('noResultsMsg');
    
    if (visibleItems.length === 0 && searchTerm) {
        if (!noResultsMsg) {
            noResultsMsg = document.createElement('div');
            noResultsMsg.id = 'noResultsMsg';
            noResultsMsg.className = 'text-center text-gray-500 py-8 col-span-full';
            noResultsMsg.textContent = 'Aucune photo trouv√©e avec ce titre.';
            photosList.appendChild(noResultsMsg);
        }
    } else {
        if (noResultsMsg) {
            noResultsMsg.remove();
        }
    }
}

// Event listener pour la recherche dans admin
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('searchPhotosInput');
    if (searchInput) {
        searchInput.addEventListener('input', searchPhotos);
    }
});

async function uploadImage() {
    const fileInput = document.getElementById('imageInput');
    const categoryInput = document.getElementById('categoryInput');
    const status = document.getElementById('status');
    const btn = document.getElementById('uploadBtn');
    const file = fileInput.files[0];
    
    if (!file) {
        status.textContent = 'S√©lectionne une image avant d\'envoyer.';
        status.className = 'text-sm text-red-600 mt-2';
        return;
    }
    
    status.textContent = '‚è≥ Envoi en cours...';
    status.className = 'text-sm text-blue-600 mt-2';
    btn.disabled = true;
    
    try {
        // 1. Obtenir la signature depuis le serveur
        const sigResponse = await fetch('/get-signature');
        const sigData = await sigResponse.json();
        
        if (!sigResponse.ok) {
            throw new Error(sigData.error || 'Erreur lors de la g√©n√©ration de la signature');
        }
        
        // 2. Upload direct vers Cloudinary depuis le navigateur
        const cloudinaryFormData = new FormData();
        cloudinaryFormData.append('file', file);
        cloudinaryFormData.append('api_key', sigData.api_key);
        cloudinaryFormData.append('timestamp', sigData.timestamp);
        cloudinaryFormData.append('signature', sigData.signature);
        cloudinaryFormData.append('folder', sigData.folder);
        
        const uploadResponse = await fetch(
            `https://api.cloudinary.com/v1_1/${sigData.cloud_name}/image/upload`,
            {
                method: 'POST',
                body: cloudinaryFormData
            }
        );
        
        const uploadResult = await uploadResponse.json();
        
        if (!uploadResponse.ok) {
            throw new Error(uploadResult.error?.message || 'Erreur lors de l\'upload vers Cloudinary');
        }
        
        // 3. Enregistrer la photo dans la galerie
        const addResponse = await fetch('/add-photo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                public_id: uploadResult.public_id,
                created_at: uploadResult.created_at,
                category: categoryInput.value  // Le backend convertira en categories
            })
        });
        
        const addResult = await addResponse.json();
        
        if (addResult.success) {
            status.textContent = '‚úÖ Photo upload√©e avec succ√®s !';
            status.className = 'text-sm text-green-600 mt-2';
            fileInput.value = '';
            categoryInput.value = 'Non cat√©goris√©';
            // Recharger la page pour mettre √† jour les stats
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            status.textContent = '‚ùå Erreur: ' + addResult.error;
            status.className = 'text-sm text-red-600 mt-2';
        }
    } catch (error) {
        status.textContent = '‚ùå Erreur: ' + error.message;
        status.className = 'text-sm text-red-600 mt-2';
        console.error('Erreur upload:', error);
    } finally {
        btn.disabled = false;
    }
}
</script>
{% endblock %}

